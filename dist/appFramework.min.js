$.app={};var app={ctx:null,mCtx:null,DB_INSTANCE:null,online:!1};app.system={createSelectors:function(templateHtml){var selectors={},idList=app.util.System.findStringBetween(templateHtml,'id="','"');return $.each(idList,function(i,id){var newId=id+"-"+app.util.System.hash();selectors[id]=function(){var selector=$("#"+newId);return selector.plainId=newId,selector},templateHtml=templateHtml.replace('id="'+id+'"','id="'+newId+'"')}),{html:templateHtml,selectors:selectors}},waitUntilReady:function(_controller,callBack){return _controller.ready!==!0?void setTimeout(function(){app.system.waitUntilReady(_controller,callBack)},10):void callBack()},waitUntilComponentsReady:function(callBack){return app.component.componentsReady!==app.component.total?void setTimeout(function(){app.system.waitUntilComponentsReady(callBack)},10):void callBack()},renderModal:function(_modal,data){app.cordova.checkNetwork(),app.system.waitUntilReady(_modal,function(){app.mCtx=$.extend(!0,{},app.modal[_modal.fullName]),void 0==data&&(data=null),app.mCtx.render(data)})},render:function(_controller,data,callBack){app.cordova.checkNetwork(),app.system.waitUntilReady(_controller,function(){app.ctx=$.extend(!0,{},app.controller[_controller.fullName]),app.system.waitUntilComponentsReady(function(){app.system.hideModal(),void 0==data&&(data=null),app.ctx.render(data),$.each(app.ctx.components,function(i,componentName){app.component[componentName].init(data)}),void 0!==callBack&&callBack()})})},hideModal:function(){null!=app.mCtx&&(app.mCtx.hide(),app.mCtx=null)},init:function(callBack){$(document).ready(function(){app.cordova.initializeCordova(function(){app.database.createDB(callBack)})})},exit:function(){navigator.app.exitApp()},mainRender:function(callBack){app.system.render(app.controller[app.config.mainController],null,callBack)}},app.component={total:0,componentsReady:0,register:function(name,obj){app.component.total++,obj.type="COMPONENT",obj.name=name.substring(0,1).toLowerCase()+name.substring(1,name.length),obj.fullName=name,obj.ready=!1,obj.data={},obj.clean=function(){app.component[name].data={}},app.component[name]=obj;var tempTemplateId="#temp-template-"+app.util.System.hash();$("body").append('<div id="'+tempTemplateId.replace("#","")+'"></div>'),$(tempTemplateId).load(app.config.viewsPath+"/component/"+obj.name+"/"+obj.name+".view.html",function(){var templateHtml=$(tempTemplateId).html(),selectorsObj=app.system.createSelectors(templateHtml);app.component[name].selector=selectorsObj.selectors,templateHtml=selectorsObj.html,templateHtml=app.message.replace(templateHtml),app.component[name].template=templateHtml,$(tempTemplateId).remove(),app.component[name].ready=!0,app.component.componentsReady++})}},app.config={mobileRun:!1,mockApi:!1,mainController:"Home",viewsPath:"view",lang:"en",dbMode:"create-drop",dbTestMode:!0,dbCreateDropFromScript:!0,dbCreateScript:"sql/create.sql",dbDropScript:"sql/drop.sql",dbTestScript:"sqltest.sql",dbProductionScript:"sqlproduction.sql",dbName:"localdb",extend:function(configObj){for(var prop in configObj)app.config[prop]=configObj[prop]}},app.controller={register:function(name,obj){void 0!=obj.components&&null!=obj.components||(obj.components=[]),void 0!=obj.view&&null!=obj.view||(obj.view="main"),obj.name=name.substring(0,1).toLowerCase()+name.substring(1,name.length),obj.fullName=name,obj.render=function(data){$('[view="'+app.ctx.view+'"]').html(obj.template),obj.init(data)},obj.componentsReady=0;for(var i=0;i<obj.components;i++)app.system.render(obj.components[i]);obj.data={},obj.ready=!1,app.controller[name]=obj;var tempTemplateId="#temp-template-"+app.util.System.hash();$("body").append('<div id="'+tempTemplateId.replace("#","")+'"></div>'),$(tempTemplateId).load(app.config.viewsPath+"/controller/"+obj.name+"/"+obj.name+".view.html",function(){var templateHtml=$(tempTemplateId).html(),selectorsObj=app.system.createSelectors(templateHtml);app.controller[name].selector=selectorsObj.selectors,templateHtml=selectorsObj.html,templateHtml=app.message.replace(templateHtml),$.each(app.controller[name].components,function(i,componentName){var _component=app.component[componentName];templateHtml=templateHtml.split('<component name="'+_component.name+'"></component>').join(_component.template)}),app.controller[name].template=templateHtml,$(tempTemplateId).remove(),app.controller[name].ready=!0})}},app.cordova={initializeCordova:function(callBack){app.cordova.bindDOMEvents(),callBack()},bindDOMEvents:function(){document.addEventListener("deviceready",app.cordova.onDeviceReady,!1),document.addEventListener("backbutton",app.cordova.onBack,!1),void 0!==app.events.domEvents&&app.events.domEvents()},checkNetwork:function(){app.plugins.wrapper.network.connection(function(){app.cordova.onOnline()},function(){app.cordova.onOffline()})},onBack:function(e){e&&e.preventDefault(),console.log("x"),null!==app.mCtx&&void 0!==app.mCtx.onBack?app.mCtx.onBack():null!==app.mCtx&&void 0==app.mCtx.onBack?app.system.hideModal():null!==app.ctx&&void 0!==app.ctx.onBack?app.ctx.onBack():void 0!==app.events.onBack&&app.events.onBack()},onDeviceReady:function(){app.cordova.checkNetwork(function(){})},onOnline:function(){app.online=!0,void 0!==app.events.onOnline&&app.events.onOnline()},onOffline:function(){app.online=!1,void 0!==app.events.onOffline&&app.events.onOffline()}},app.crud={replaceBooleanToString:function(sql){return sql=sql.split("'true'").join("'bool_true'"),sql=sql.split("'false'").join("'bool_false'")},execute:function(sql,successCallback,errorCallback){"string"!=typeof sql&&(sql=sql()),sql=this.replaceBooleanToString(sql),console.log(sql);var array=[],lastId=null;app.DB_INSTANCE.transaction(function(tx){tx.executeSql(sql,[],function(tx,results){var i,len=results.rows.length;for(i=0;len>i;i++){var item=results.rows.item(i);array.push(item)}sql.toLowerCase().indexOf("insert")>-1&&(lastId=results.insertId)},null)},function(err){void 0!==errorCallback&&errorCallback(),console.error(err)},function(){void 0!==successCallback&&successCallback(-1!=sql.toLowerCase().indexOf("insert")?lastId:array)})},builder:{findById:function(tableName,id){return"select * from "+tableName+" where id = "+id},deleteById:function(tableName,id){return"delete from "+tableName+" where id = "+id},drop:function(tableName){return"DROP TABLE IF EXISTS "+tableName},count:function(tableName){return"select count(*) as count from "+tableName},create:function(tableName,columns){for(var sql="CREATE TABLE IF NOT EXISTS "+tableName+" (id INTEGER PRIMARY KEY",i=0;i<columns.length;i++)sql+=", "+columns[i];return sql+=")"},findAll:function(tableName){return"SELECT * FROM "+tableName},select:function(tableName,values,columns){var sql="";sql="select * from "+tableName+" where ";for(var i=0;i<values.length;i++)sql+="string"==typeof values[i]||"boolean"==typeof values[i]?" "+columns[i]+"='"+values[i]+"' and ":" "+columns[i]+"="+values[i]+" and ";return sql=sql.substr(0,sql.length-4)},insert:function(tableName,values,columns){var sql="";if(void 0!==columns){sql="INSERT INTO "+tableName+" (";for(var i=0;i<columns.length;i++)sql+=columns[i]+",";sql=sql.substr(0,sql.length-1),sql+=") VALUES ("}else sql="INSERT INTO "+tableName+" VALUES (";for(var i=0;i<values.length;i++)sql+="string"==typeof values[i]||"boolean"==typeof values[i]?" '"+values[i]+"',":" "+values[i]+",";return sql=sql.substr(0,sql.length-1),sql+=")"},update:function(tableName,id,values,columns){var sql="";sql="UPDATE "+tableName+" SET ";for(var i=0;i<values.length;i++)sql+="string"==typeof values[i]||"boolean"==typeof values[i]?" "+columns[i]+"= '"+values[i]+"',":" "+columns[i]+"= "+values[i]+",";return sql=sql.substr(0,sql.length-1),sql+=" where id = "+id}}},app.dbTablesCount=0,app.database={dbName:"",dbVersion:"1.0",dbSize:2097152,createDB:function(callBack){app.database.dbName=app.config.dbName,"none"==app.config.dbMode?(app.DB_INSTANCE=null,app.system.mainRender(callBack)):(app.config.mobileRun?app.DB_INSTANCE=window.sqllitePlugin.openDatabase(app.database.dbName,app.database.dbVersion,app.database.dbName+"_manager",app.database.dbSize):app.DB_INSTANCE=openDatabase(app.database.dbName,app.database.dbVersion,app.database.dbName+"_manager",app.database.dbSize),"create-drop"==app.config.dbMode?app.database.dbDrop(function(){app.database.dbCreate(function(){app.database.dbLoadData(function(){app.system.mainRender(callBack)})})}):"create"==app.config.dbMode&&(null==localStorage.getItem("db_created")?app.database.dbCreate(function(){app.database.dbLoadData(function(){app.system.mainRender(callBack),localStorage.setItem("db_created",!0)})}):app.system.mainRender(callBack)))},dbLoadData:function(callBack){var finished=!1;app.config.dbTestMode?app.rest.getFile(app.config.dbTestScript,function(data){if(0==data.trim().length)console.log("callback 2"),finished=!0,callBack();else{for(var queries=[],splitted=data.split(";"),i=0;i<splitted.length;i++)splitted[i].trim().length>0&&0==splitted[i].trim().indexOf("/*")&&queries.push(splitted[i].trim());for(var i=0;i<queries.length;i++)app.crud.execute(queries[i],function(data){app.dbTablesCount++,app.dbTablesCount>=queries.length&&(app.dbTablesCount=0,finished||(console.log("callback 1"),finished=!0,callBack()))})}}):app.rest.getFile(app.config.dbProductionScript,function(data){if(0==data.trim().length)console.log("callback 3"),finished=!0,callBack();else{for(var queries=[],splitted=data.split(";"),i=0;i<splitted.length;i++)splitted[i].trim().length>0&&queries.push(splitted[i].trim());for(var i=0;i<queries.length;i++)app.crud.execute(queries[i],function(data){app.dbTablesCount++,app.dbTablesCount>=queries.length&&(app.dbTablesCount=0,finished||(console.log("callback 4"),finished=!0,callBack()))})}})},dbCreate:function(callBack){if(app.config.dbCreateDropFromScript)app.rest.getFile(app.config.dbCreateScript,function(data){if(0==data.trim().length)callBack();else{for(var queries=[],splitted=data.split(";"),i=0;i<splitted.length;i++)splitted[i].trim().length>0&&queries.push(splitted[i].trim());for(var i=0;i<queries.length;i++)app.crud.execute(queries[i],function(data){app.dbTablesCount++,app.dbTablesCount>=queries.length&&(app.dbTablesCount=0,callBack())})}});else for(var i=0;i<app.model.createScripts.length;i++)app.crud.execute(app.model.createScripts[i],function(data){app.dbTablesCount++,app.dbTablesCount==app.model.createScripts.length&&(app.dbTablesCount=0,callBack())})},dbDrop:function(callBack){if(app.config.dbCreateDropFromScript)app.rest.getFile(app.config.dbDropScript,function(data){if(0==data.trim().length)callBack();else{for(var queries=[],splitted=data.split(";"),i=0;i<splitted.length;i++)splitted[i].trim().length>0&&queries.push(splitted[i].trim());for(var i=0;i<queries.length;i++)app.crud.execute(queries[i],function(data){app.dbTablesCount++,app.dbTablesCount>=queries.length&&(app.dbTablesCount=0,callBack())})}});else for(var i=0;i<app.model.dropScripts.length;i++)app.crud.execute(app.model.dropScripts[i],function(data){app.dbTablesCount++,app.dbTablesCount==app.model.dropScripts.length&&(app.dbTablesCount=0,callBack())})}},app.enumerator={register:function(name,list){app.enumerator[name]=list}},app.events={domEvents:function(){},onOnline:function(){},onOffline:function(){},onBack:function(){},extend:function(eventName,eventCallback){"offline"==eventName&&(eventName="onOffline"),"online"==eventName&&(eventName="onOnline"),"dom"==eventName&&(eventName="domEvents"),"back"==eventName&&(eventName="onBack"),app.events[eventName]=eventCallback}},app.global={define:function(name,value){app.global[name]={get:function(){return window[name]},set:function(val){window[name]=val}},window[name]=value},defineMap:function(hashMap){$.each(hashMap,function(i,_global){app.global.define(_global.name,_global.initial)})}},app.message={messages:null,define:function(object){app.message.messages=object},get:function(_message){for(prop in app.message.messages)if(prop.toString()==_message)for(prop2 in app.message.messages[prop])if(prop2.toString()==app.config.lang)return app.message.messages[prop][prop2]},replace:function(html){for(prop in app.message.messages)html=html.split("msg("+prop.toString()+")").join(app.message.messages[prop][app.config.lang]);return html}},app.modal={register:function(name,obj){obj.name=name.substring(0,1).toLowerCase()+name.substring(1,name.length),obj.fullName=name,obj.data={},obj.ready=!1,app.modal[name]=obj;var tempTemplateId="#temp-template-"+app.util.System.hash();$("body").append('<div id="'+tempTemplateId.replace("#","")+'"></div>'),$(tempTemplateId).load(app.config.viewsPath+"/modal/"+obj.name+"/"+obj.name+".view.html",function(){var modalSelector=$("[mainmodal]"),newModalId="modal-"+app.util.System.hash();modalSelector.attr("modalselector",newModalId),app.modal[name].id=newModalId,app.modal[name].selfSelector=function(){return $('[modalselector="'+newModalId+'"]')},obj.show=function(){app.modal[name].selfSelector().modal("show")},obj.hide=function(){app.modal[name].selfSelector().modal("hide"),app.mCtx=null},obj.render=function(data){$('[modal="'+obj.name+'"]').html(obj.template),obj.selfSelector().modal(),obj.init(data),obj.show()};var templateHtml=$(tempTemplateId).html(),selectorsObj=app.system.createSelectors(templateHtml);app.modal[name].selector=selectorsObj.selectors,templateHtml=selectorsObj.html,app.modal[name].template=templateHtml,$(tempTemplateId).remove(),app.modal[name].ready=!0})}},app.model={createScripts:[],dropScripts:[],define:function(name,fieldList){var columnsWithId=$.app.copyArray(fieldList).unshift("id"),nameUpperCase=name.toUpperCase(),dropTableSql=app.crud.builder.drop(nameUpperCase),createTableSql=app.crud.builder.create(nameUpperCase,fieldList),findAllSql=app.crud.builder.findAll(nameUpperCase);app.model.createScripts.push(createTableSql),app.model.dropScripts.push(dropTableSql);var obj={table:nameUpperCase,name:nameUpperCase,columns:fieldList,columnsAll:columnsWithId,dropSQL:dropTableSql,createSQL:createTableSql,findAllSQL:findAllSql,"new":function(objList){for(var modelObj={},i=0;i<this.columns;i++)void 0!==objList[this.columns[i]]?modelObj[this.columns[i]]=objList[this.columns[i]]:modelObj[this.columns[i]]=null;return modelObj}};app.model[name]=obj}},app.plugins={wrapper:{},wrapList:function(wrapList){app.plugins.wrapper=$.extend(!0,app.plugins.wrapper,wrapList)},wrap:function(pluginName,wrapper){app.plugins.wrapper[pluginName]=wrapper}},app.query={defineList:function(list){$.each(list,function(i,queryObj){app.query.define(queryObj.name,queryObj.sql,queryObj.group)})},define:function(name,sql,group){var obj={sql:sql,bind:function(valueListOrObj){var sql=this.sql;if(valueListOrObj instanceof Array)for(var i=0;i<valueListOrObj.length;i++)sql="string"==typeof valueListOrObj[i]?sql.replace("?","'"+valueListOrObj[i]+"'"):sql.replace("?",valueListOrObj[i]);else for(var fieldName in valueListOrObj){var fieldValue=valueListOrObj[fieldName];sql="string"==typeof fieldValue?sql.replace(":"+fieldName,"'"+valueListOrObj[i]+"'"):sql.replace(":"+fieldName,fieldValue)}return sql},execute:function(successCallback,errorCallback,valueList){var sqlToExecute=this.sql;void 0!==valueList&&(sqlToExecute=this.bind(valueList)),crud.execute(sqlToExecute,successCallback,errorCallback)}};void 0==group?app.query[name]=obj:(void 0==app.query[group]&&(app.query[group]={}),app.query[group][name]=obj)}},app.rest={spinnerFunct:function(){},getFile:function(url,successCallback,errorCallback){$.ajax({url:url,success:successCallback,error:errorCallback,cache:!1})},get:function(url,successCallback,errorCallback,headers){app.rest.getDelete(url,"GET",successCallback,errorCallback,headers)},"delete":function(url,successCallback,errorCallback,headers){app.rest.getDelete(url,"DELETE",successCallback,errorCallback,headers)},update:function(url,request,successCallback,errorCallback,headers){app.rest.postPut(url,"PUT",request,successCallback,errorCallback,headers)},post:function(url,request,successCallback,errorCallback,headers){app.rest.postPut(url,"POST",request,successCallback,errorCallback,headers)},isMock:function(url,method,request,successCallback,callBackIsnt){if(app.config.mockApi){var result=app.mock.execByUrl(url,method,request);successCallback(result)}else callBackIsnt()},getDelete:function(url,method,urlParams,successCallback,errorCallback,headers){app.rest.isMock(url,method,null,successCallback,function(){var preparedUrl=null;preparedUrl=void 0!==urlParams&&null!==urlParams?app.util.System.prepareUrl(url,urlParams):url,$.ajax({url:preparedUrl,type:method,beforeSend:function(){app.rest.spinnerFunct()},complete:function(){app.rest.spinnerFunct=function(){}},headers:headers,contentType:"application/json; charset=utf-8",dataType:"json",success:function(data,textStatus,jqXHR){successCallback(data)},error:function(jqXHR,textStatus,errorThrown){void 0!==errorCallback&&errorCallback(jqXHR.status,jqXHR)}})})},postPut:function(url,method,request,successCallback,errorCallback,headers,urlParams){app.rest.isMock(url,method,request,successCallback,function(){var preparedUrl=null;preparedUrl=void 0!==urlParams&&null!==urlParams?app.util.System.prepareUrl(url,urlParams):url;var jsonData=JSON.stringify(request);$.ajax({url:preparedUrl,type:method,beforeSend:function(){app.rest.spinnerFunct()},complete:function(){app.rest.spinnerFunct=function(){}},headers:headers,contentType:"application/json; charset=utf-8",dataType:"json",data:jsonData,success:function(data,textStatus,jqXHR){successCallback(data)},error:function(jqXHR,textStatus,errorThrown){errorCallback(jqXHR.status,jqXHR)}})})}},app.service={register:function(name,obj){app.service[name]=obj}},app.util={register:function(name,obj){app.util[name]=obj},System:{isNull:function(obj){return void 0==obj||null==obj},prepareUrl:function(url,params){for(var prop in params)url=url.replace("{"+prop+"}",params[prop]);return url},findStringBetween:function(str,first,last){var r=new RegExp(first+"(.*?)"+last,"gm"),arr=str.match(r);if(null==arr||0==arr.length)return[];for(var arr2=[],i=0;i<arr.length;i++)arr2.push(arr[i].replace('id="',"").replace('"',""));return arr2},hash:function(){for(var text="",possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;5>i;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text}}},app.mock={api:{},execByUrl:function(url,method,request){for(prop in app.mock.api)if(app.mock.api[prop].url==url)return app.mock.api[prop].exec(request)},execByName:function(name,method,request){for(prop in app.mock.api)if(prop==name&&app.mock.api[prop].method==method.toLowerCase())return app.mock.api[prop].exec(request)},registerList:function(mockList){$.each(mockList,function(i,mockObj){app.mock.register(mockObj.name,mockObj.url,mockObj.method,mockObj.returning)})},register:function(name,url,method,returning){var urlVal=null;urlVal="string"==typeof url?url:url(),app.mock.api[name]={url:urlVal,method:method,exec:returning}}},app.renderer={define:function(name,template){var htmlTemplate=null;htmlTemplate="string"==typeof template?template:template();var obj={template:htmlTemplate,render:function(listSelector,data,bindings){var elementsHtml=[];console.log(html);var dataIds=[],templatehtml=this.template,html=templatehtml;$.each(data,function(i,element){var dataId="element-"+app.util.System.hash();html=html.split("event(").join(' dataId="'+dataId+'" event('),dataIds.push({dataId:dataId,context:element});for(var prop in element)html=html.split("text("+prop+")").join(element[prop]);elementsHtml.push(html),html=templatehtml}),html="";for(var i=0;i<elementsHtml.length;i++)html+=elementsHtml[i];for(var prop in bindings)html=html.split("event("+prop+")").join('event="'+prop+'"');listSelector.html(html),this.bind(listSelector,dataIds,bindings)},bind:function(listSelector,dataIds,bindings){var dataIdsLocal=dataIds;for(var prop in bindings){var event="click";void 0!==bindings[prop].eventType&&(event=bindings[prop].eventType),listSelector.on(event,'[event="'+prop+'"]',function(e){var arrtributeDataId=$(e.currentTarget).attr("dataId");$.each(dataIdsLocal,function(i,dataId){dataId.dataId==arrtributeDataId&&(e.eCtx=dataId.context)}),bindings[prop](e)})}}};app.renderer[name]=obj}};